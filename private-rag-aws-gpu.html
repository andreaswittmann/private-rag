<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-11-20 Thu 20:30 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Private RAG AWS GPU Deployment - Live-Scripting Workflow</title>
<meta name="author" content="Andreas Wittmann" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="aw-org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="aw-org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="aw-org-html-themes/styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="aw-org-html-themes/styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="aw-org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="aw-org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Private RAG AWS GPU Deployment - Live-Scripting Workflow</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org513740f">1. Summary</a></li>
<li><a href="#orgd983846">2. Building Privacy-Focused RAG Platform with GPU Acceleration</a>
<ul>
<li><a href="#org1d21a2d">2.1. Project Overview</a></li>
<li><a href="#orgc531282">2.2. Live-Scripting Methodology</a>
<ul>
<li><a href="#org3177ea5">2.2.1. Implementation Options</a>
<ul>
<li><a href="#org558536c">2.2.1.1. Emacs Users</a></li>
<li><a href="#orgfe70640">2.2.1.2. Non-Emacs Users</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb2b28c4">2.3. Expected Deployment Outcome</a></li>
</ul>
</li>
<li><a href="#org31d293b">3. Foundation &amp; Prerequisites</a>
<ul>
<li><a href="#org67ffd7a">3.1. Environment Setup</a>
<ul>
<li><a href="#org762b61a">3.1.1. Bootstrapping with Cloning private-rag Repository</a></li>
<li><a href="#org2a23f2b">3.1.2. Setting the Project Foundation</a></li>
</ul>
</li>
<li><a href="#orgd7750e9">3.2. Summary</a></li>
</ul>
</li>
<li><a href="#org10bedf3">4. Infrastructure as Code</a>
<ul>
<li><a href="#org03996ed">4.1. SSH Key Generation for Secure Access</a></li>
<li><a href="#org0d2fcaa">4.2. Terraform Configuration and Planning</a></li>
<li><a href="#org2f5c9e0">4.3. Infrastructure Deployment Planning</a></li>
<li><a href="#org4cf74ea">4.4. Infrastructure Deployment Execution</a></li>
<li><a href="#org7db99b9">4.5. SSH Configuration for Easy Access</a></li>
<li><a href="#org510a74b">4.6. GPU Instance Selection and Upgrading</a>
<ul>
<li><a href="#org9fbcd5d">4.6.1. Recommended GPU EC2 Instance Types for RAG Workloads</a>
<ul>
<li><a href="#orgf6612ec">4.6.1.1. Recommendations</a></li>
</ul>
</li>
<li><a href="#orgd8d1d90">4.6.2. Upgrading to a Different GPU Instance Type with Terraform</a></li>
</ul>
</li>
<li><a href="#org30c8e7c">4.7. Summary</a></li>
</ul>
</li>
<li><a href="#org7ef261d">5. GPU Verification</a></li>
<li><a href="#org9abda6e">6. Development Environment Setup</a>
<ul>
<li><a href="#org6d86636">6.1. Complete Docker Engine and Tools Installation</a>
<ul>
<li><a href="#orgf0c4708">6.1.1. Docker Engine Installation and Tools</a></li>
<li><a href="#org3f6c0f8">6.1.2. Python Development Tools Installation</a></li>
<li><a href="#orgd9bb34e">6.1.3. Development Environment Summary</a></li>
</ul>
</li>
<li><a href="#orgad58f50">6.2. Summary</a></li>
</ul>
</li>
<li><a href="#org852abf4">7. Core RagFlow Deployment</a>
<ul>
<li><a href="#orgfdaf97f">7.1. Basic Ragflow Setup</a></li>
<li><a href="#org27bfe0d">7.2. HTTPS Setup with Self-Signed Certificate</a>
<ul>
<li><a href="#org39644d2">7.2.1. Step 1: Generate Self-Signed SSL Certificate**</a></li>
<li><a href="#org3faa15f">7.2.2. Step 2: Modify Nginx Configuration**</a></li>
<li><a href="#org9fbfb2e">7.2.3. Step 3: Update Docker Compose Configuration</a></li>
<li><a href="#orgf3fa0bd">7.2.4. Step 4: Restart RAGFlow Services</a></li>
<li><a href="#org8612421">7.2.5. Step 5: Test HTTPS Access</a></li>
</ul>
</li>
<li><a href="#orgbfa0956">7.3. Use Case: Access RagFlow via SSH-Tunnel</a></li>
<li><a href="#org0adc4f3">7.4. Summary</a></li>
</ul>
</li>
<li><a href="#org38c17d4">8. Advanced Features - Document Processing</a>
<ul>
<li><a href="#org75ea563">8.1. Document Ingestion and Processing</a>
<ul>
<li><a href="#org75ba70b">8.1.1. Upload Documents</a></li>
<li><a href="#org527ec3a">8.1.2. Configure Knowledge Base</a></li>
<li><a href="#org1952bda">8.1.3. Test RAG Queries</a></li>
</ul>
</li>
<li><a href="#org6e8685d">8.2. Summary</a></li>
</ul>
</li>
<li><a href="#org123bb69">9. Infrastructure Cleanup</a>
<ul>
<li><a href="#org6135eba">9.1. Stop RagFlow Services (Optional)</a></li>
<li><a href="#org68975c9">9.2. Terminate GPU EC2 Instance with Terraform</a></li>
<li><a href="#orge40dac1">9.3. Clean Up Local SSH Configuration</a></li>
<li><a href="#org9c8c201">9.4. Clean Up Terraform State Files</a></li>
<li><a href="#orgfce4a6f">9.5. Verify Complete Cleanup</a></li>
<li><a href="#orgd064333">9.6. Summary</a></li>
</ul>
</li>
<li><a href="#org37103f2">10. Appendix: Live-Cycle Operations</a></li>
<li><a href="#orgce90ced">11. End</a></li>
</ul>
</div>
</div>
<div id="outline-container-org513740f" class="outline-2">
<h2 id="org513740f"><span class="section-number-2">1.</span> Summary</h2>
<div class="outline-text-2" id="text-1">
<p>
<i>This document outlines the deployment of RagFlow, an open-source RAG platform, on Ubuntu 24.04 with GPU acceleration. Using the live-scripting methodology, it contains executable code blocks that ensure reproducible infrastructure setup. It covers Terraform infrastructure provisioning with pre-configured Deep Learning AMI, Docker containerization, and RagFlow deployment with GPU support.</i>
</p>
<ul class="org-ul">
<li><b>HTML Version:</b> <a href="private-rag-aws-gpu.html">private-rag-aws-gpu.html</a></li>
<li><b>PDF Version:</b> <a href="private-rag-aws-gpu.pdf">private-rag-aws-gpu.pdf</a></li>
<li><b>GitHub:</b> <a href="https://github.com/andreaswittmann/private-rag/tree/main">https://github.com/andreaswittmann/private-rag/tree/main</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgd983846" class="outline-2">
<h2 id="orgd983846"><span class="section-number-2">2.</span> Building Privacy-Focused RAG Platform with GPU Acceleration</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org1d21a2d" class="outline-3">
<h3 id="org1d21a2d"><span class="section-number-3">2.1.</span> Project Overview</h3>
<div class="outline-text-3" id="text-2-1">
<p>
This project uses the live-scripting methodology to create an example configuration of the open-source project RagFlow on Ubuntu 24.04 with GPU support. Live-scripting represents an intermediate approach between manual command-line work and fully automated CI/CD pipelines, enabling the development of documented, shareable, and reproducible solutions.
</p>

<p>
Using Infrastructure as Code methods with Terraform, an AWS environment with GPU-enabled EC2 instance running Ubuntu 24.04 is established as a platform for RagFlow installation. The Deep Learning AMI comes pre-configured with NVIDIA drivers and CUDA toolkit, eliminating manual GPU setup. The example demonstrates all necessary configuration and software tool installations required for the project. To test the installation a sample use case shows the how an document is ingested and queried using RagFlow UI. A section in the end outlines the steps for removing the infrastructure completely.
</p>
</div>
</div>
<div id="outline-container-orgc531282" class="outline-3">
<h3 id="orgc531282"><span class="section-number-3">2.2.</span> Live-Scripting Methodology</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The deployment uses live-scripting methodology to transform static documentation into executable workflows. Code blocks can be executed step by step directly in Emacs (F4 key) or be copied to any terminal, creating a bridge between documentation and execution.
</p>

<p>
Based on the [live-scripting methodology](<a href="https://github.com/andreaswittmann/live-scripting">https://github.com/andreaswittmann/live-scripting</a>), this approach provides:
</p>

<ul class="org-ul">
<li>Executable documentation with current and functional code blocks</li>
<li>Multi-format publishing from single Orgmode File to HTML and PDF</li>
<li>Reproducible deployments with consistent infrastructure setup</li>
<li>Support of version control through plain-text format</li>
</ul>
</div>
<div id="outline-container-org3177ea5" class="outline-4">
<h4 id="org3177ea5"><span class="section-number-4">2.2.1.</span> Implementation Options</h4>
<div class="outline-text-4" id="text-2-2-1">
</div>
<div id="outline-container-org558536c" class="outline-5">
<h5 id="org558536c"><span class="section-number-5">2.2.1.1.</span> Emacs Users</h5>
<div class="outline-text-5" id="text-2-2-1-1">
<p>
Configure live-scripting with this Emacs Lisp function:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"># Listing: Emacs Lisp function for sending current line or region to vterm
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Put this to your  ~/.emacs.d/personal/my_custom.el or similar file and load it.</span>

(<span style="color: #0000FF; font-weight: bold;">defun</span> <span style="color: #006699;">my-select-current-line</span> ()
  <span style="color: #036A07;">"Selects the current line, including the NEXT-LINE char at the end"</span>
  (<span style="color: #0000FF; font-weight: bold;">interactive</span>)
  (move-beginning-of-line nil)
  (set-mark-command nil)
  (move-end-of-line 2)
  (move-beginning-of-line nil)
  (<span style="color: #0000FF; font-weight: bold;">setq</span> deactivate-mark nil))

(<span style="color: #0000FF; font-weight: bold;">defun</span> <span style="color: #006699;">send-line-to-vterm</span> ()
  <span style="color: #036A07;">"Send region if active, or current line to vterm buffer. Then move to next line."</span>
  (<span style="color: #0000FF; font-weight: bold;">interactive</span>)
  (<span style="color: #0000FF; font-weight: bold;">if</span> (region-active-p)
      (send-region <span style="color: #008000;">"*vterm*"</span> (region-beginning) (region-end))
    (my-select-current-line)
    (send-region <span style="color: #008000;">"*vterm*"</span> (region-beginning) (region-end)))
  (deactivate-mark))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfe70640" class="outline-5">
<h5 id="orgfe70640"><span class="section-number-5">2.2.1.2.</span> Non-Emacs Users</h5>
<div class="outline-text-5" id="text-2-2-1-2">
<p>
Copy code blocks to any terminal, 
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb2b28c4" class="outline-3">
<h3 id="orgb2b28c4"><span class="section-number-3">2.3.</span> Expected Deployment Outcome</h3>
<div class="outline-text-3" id="text-2-3">
<p>
The workflow produces a functioning HTTPS-enabled RagFlow instance on AWS with GPU acceleration, capable of document processing and RAG-based AI responses with full user control and enhanced performance.
</p>
</div>
</div>
</div>
<div id="outline-container-org31d293b" class="outline-2">
<h2 id="org31d293b"><span class="section-number-2">3.</span> Foundation &amp; Prerequisites</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org67ffd7a" class="outline-3">
<h3 id="org67ffd7a"><span class="section-number-3">3.1.</span> Environment Setup</h3>
<div class="outline-text-3" id="text-3-1">
<p>
These steps establish the development environment and validate prerequisites.
</p>
</div>
<div id="outline-container-org762b61a" class="outline-4">
<h4 id="org762b61a"><span class="section-number-4">3.1.1.</span> Bootstrapping with Cloning private-rag Repository</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
This creates a Lab directory and clones the private-rag repository for subsequent live-scripting consumption with Emacs.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Cloning private-rag repository</span>

<span style="color: #006FE0;">export</span> <span style="color: #BA36A5;">BASE_DIR</span>=<span style="color: #008000;">"~/$(whoami)/Labs"</span>
mkdir -p $<span style="color: #BA36A5;">BASE_DIR</span>
<span style="color: #006FE0;">cd</span> $<span style="color: #BA36A5;">BASE_DIR</span>

git clone https://github.com/andreaswittmann/private-rag.git

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">open in Emacs: ~/$(whoami)/Labs/private-rag/private-rag-aws-gpu.org</span>

</pre>
</div>

<p>
To fowllow along usnig the live-scripting methodology, open the file ~/$(whoami)/Labs/private-rag/private-rag-aws-gpu.org in Emacs.
</p>
</div>
</div>
<div id="outline-container-org2a23f2b" class="outline-4">
<h4 id="org2a23f2b"><span class="section-number-4">3.1.2.</span> Setting the Project Foundation</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
This establishes the base project directory and validates AWS network prerequisites.
</p>


<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Project environment setup</span>

bash
<span style="color: #BA36A5;">PROJECT_DIR</span>=<span style="color: #008000;">"~/$(whoami)/Labs/private-rag"</span>
<span style="color: #006FE0;">cd</span> <span style="color: #008000;">"$PROJECT_DIR"</span>
<span style="color: #006FE0;">pwd</span>
ls -la

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Set AWS profile for this session</span>
<span style="color: #006FE0;">export</span> <span style="color: #BA36A5;">AWS_PROFILE</span>=lab-a-north
<span style="color: #006FE0;">echo</span> $<span style="color: #BA36A5;">AWS_PROFILE</span>

<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">create default VPC if it does not exist</span>
aws ec2 create-default-vpc
<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">check if the default vpc is created</span>
aws ec2 describe-vpcs --filters <span style="color: #008000;">"Name=isDefault,Values=true"</span> --query <span style="color: #008000;">"Vpcs[0].VpcId"</span> --output text

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Ensuring AWS access and basic services availability</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Test basic AWS connectivity</span>
aws s3 ls

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify AWS identity and permissions</span>
aws sts get-caller-identity

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify SSH key is available for EC2 access</span>
ls -la ~/.ssh/

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Validate required tools are installed</span>
terraform --version

</pre>
</div>

<p>
<b>Result:</b> Project environment is configured and AWS default VPC, AWS credentials and required tools are validated for infrastructure deployment.
</p>
</div>
</div>
</div>
<div id="outline-container-orgd7750e9" class="outline-3">
<h3 id="orgd7750e9"><span class="section-number-3">3.2.</span> Summary</h3>
<div class="outline-text-3" id="text-3-2">
<p>
The foundation phase establishes the development environment by cloning the private-rag repository and setting the project foundation. AWS credentials are verified, default VPC created if needed, S3 access tested, STS identity confirmed, SSH keys validated, and required tools like Terraform checked. This groundwork enables reproducible infrastructure deployment through live-scripting methodology.
</p>
</div>
</div>
</div>
<div id="outline-container-org10bedf3" class="outline-2">
<h2 id="org10bedf3"><span class="section-number-2">4.</span> Infrastructure as Code</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org03996ed" class="outline-3">
<h3 id="org03996ed"><span class="section-number-3">4.1.</span> SSH Key Generation for Secure Access</h3>
<div class="outline-text-3" id="text-4-1">
<p>
This block creates dedicated SSH keypairs for EC2 instance access and stores the public key for Terraform.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: SSH key generation for EC2 access</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Creating dedicated SSH keys for secure instance access</span>

<span style="color: #006FE0;">cd</span> <span style="color: #008000;">"$PROJECT_DIR"</span>
<span style="color: #006FE0;">pwd</span>;
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Generate a new SSH key pair specifically for RagFlow GPU</span>
ssh-keygen -t rsa -b 4096 -f ~/.ssh/ragflow-gpu_key -N <span style="color: #008000;">""</span>
y
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Display the public key for use in Terraform variables</span>
ls -la ~/.ssh/ragflow-gpu_key*
cat ~/.ssh/ragflow-gpu_key.pub

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Store public key in environment variable</span>
<span style="color: #006FE0;">export</span> <span style="color: #BA36A5;">TF_VAR_SSH_PUBLIC_KEY</span>=<span style="color: #008000;">"$(cat ~/.ssh/ragflow-gpu_key.pub)"</span>
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"SSH public key configured: $TF_VAR_SSH_PUBLIC_KEY"</span>
</pre>
</div>

<p>
<b>Result:</b> SSH keypair is generated and public key is exported for infrastructure provisioning.
</p>
</div>
</div>
<div id="outline-container-org0d2fcaa" class="outline-3">
<h3 id="org0d2fcaa"><span class="section-number-3">4.2.</span> Terraform Configuration and Planning</h3>
<div class="outline-text-3" id="text-4-2">
<p>
This prepares the Terraform configuration files and validates the infrastructure setup for GPU-enabled instance.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Terraform environment preparation</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Setting up infrastructure configuration for GPU instance</span>

<span style="color: #006FE0;">cd</span> <span style="color: #008000;">"$PROJECT_DIR/terraform-gpu"</span>
<span style="color: #006FE0;">pwd</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Create terraform variables file with GPU configuration</span>
cat &gt; terraform.tfvars &lt;&lt; EOF
<span style="color: #0000ff; background-color: #EEF5FE;"># Generated tfvars file - $(date)</span>
<span style="color: #0000ff; background-color: #EEF5FE;">aws_region       = "eu-north-1"</span>
<span style="color: #0000ff; background-color: #EEF5FE;">instance_type    = "g4dn.xlarge"</span>
<span style="color: #0000ff; background-color: #EEF5FE;">root_volume_size = 100</span>
<span style="color: #0000ff; background-color: #EEF5FE;">root_volume_type = "gp3"</span>
<span style="color: #0000ff; background-color: #EEF5FE;">allowed_ip       = "0.0.0.0/0"</span>
<span style="color: #0000ff; background-color: #EEF5FE;">ssh_public_key   = "${TF_VAR_SSH_PUBLIC_KEY}"</span>
<span style="color: #0000ff; background-color: #EEF5FE;">ec2_name         = "EC2-RagFlow-GPU"</span>
<span style="color: #0000ff; background-color: #EEF5FE;">environment      = "development"</span>
<span style="color: #0000ff; background-color: #EEF5FE;">project          = "ragflow-gpu"</span>
<span style="color: #0000ff; background-color: #EEF5FE;">ssh_cidr_blocks  = ["0.0.0.0/0"]</span>
<span style="color: #0000ff; background-color: #EEF5FE;">EOF</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Review our configuration</span>
cat terraform.tfvars

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Initialize Terraform</span>
terraform init

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Format and validate our configuration</span>
terraform fmt
terraform validate
</pre>
</div>

<p>
<b>Result:</b> Terraform configuration is initialized and validated for GPU-enabled infrastructure deployment.
</p>
</div>
</div>
<div id="outline-container-org2f5c9e0" class="outline-3">
<h3 id="org2f5c9e0"><span class="section-number-3">4.3.</span> Infrastructure Deployment Planning</h3>
<div class="outline-text-3" id="text-4-3">
<p>
This creates the deployment plan and reviews resource changes before applying them.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Terraform deployment planning</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Creating and reviewing the GPU infrastructure deployment plan</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Generate deployment plan</span>
terraform plan -out=tfplan -var-file=terraform.tfvars

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Create human-readable plan</span>
terraform show -json tfplan &gt; tfplan.json
cat tfplan.json | jq &gt; tfplan.pretty.json

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Review what resources will be created</span>
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"Resources to be created:"</span>
cat tfplan.json | jq <span style="color: #008000;">'.resource_changes[] | {address: .address, action: .change.actions[0]}'</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Summary of planned changes</span>
cat tfplan.json | jq <span style="color: #008000;">'.resource_changes | group_by(.change.actions[0]) | map({action: .[0].change.actions[0], count: length})'</span>
</pre>
</div>

<p>
<b>Result:</b> Deployment plan is generated and resource changes are reviewed for approval.
</p>
</div>
</div>
<div id="outline-container-org4cf74ea" class="outline-3">
<h3 id="org4cf74ea"><span class="section-number-3">4.4.</span> Infrastructure Deployment Execution</h3>
<div class="outline-text-3" id="text-4-4">
<p>
This executes the Terraform plan to create the AWS infrastructure resources with GPU support.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: AWS GPU infrastructure deployment</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Creating the GPU-enabled infrastructure resources</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Execute the deployment plan</span>
terraform apply tfplan
terraform apply
yes

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Capture and display outputs</span>
terraform output

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">List our EC2 instances</span>
aws ec2 describe-instances <span style="color: #008000;">\</span>
  --query <span style="color: #008000;">'Reservations[*].Instances[*].[InstanceId, InstanceType, Tags[?Key==`Name`]|[0].Value, State.Name]'</span> <span style="color: #008000;">\</span>
  --output text

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Get our instance details - get only the first/latest instance ID</span>
<span style="color: #BA36A5;">instance_id</span>=$(aws ec2 describe-instances <span style="color: #008000;">\</span>
  --filters <span style="color: #008000;">"Name=tag:Name,Values=EC2-RagFlow-GPU"</span> <span style="color: #008000;">"Name=instance-state-name,Values=running,pending,stopping,stopped"</span> <span style="color: #008000;">\</span>
  --query <span style="color: #008000;">'Reservations[*].Instances[*].[InstanceId]'</span> <span style="color: #008000;">\</span>
  --output text | head -n1)
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"Instance ID: $instance_id"</span>


<span style="color: #BA36A5;">public_ip</span>=$(aws ec2 describe-instances <span style="color: #008000;">\</span>
  --instance-ids <span style="color: #008000;">"$instance_id"</span> <span style="color: #008000;">\</span>
  --query <span style="color: #008000;">'Reservations[*].Instances[*].[PublicIpAddress]'</span> <span style="color: #008000;">\</span>
  --output text)
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"Public IP: $public_ip"</span>
<span style="color: #0000FF; font-weight: bold;">exit</span>
</pre>
</div>

<p>
<b>Result:</b> AWS GPU-enabled infrastructure is deployed and EC2 instance details are captured for subsequent configuration.
</p>
</div>
</div>
<div id="outline-container-org7db99b9" class="outline-3">
<h3 id="org7db99b9"><span class="section-number-3">4.5.</span> SSH Configuration for Easy Access</h3>
<div class="outline-text-3" id="text-4-5">
<p>
This establishes convenient SSH access configuration and tests connectivity to the deployed GPU instance.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: SSH configuration setup for GPU instance</span>

<span style="color: #006FE0;">pwd</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Test initial SSH connection</span>
ssh -i ~/.ssh/ragflow-gpu_key ubuntu@<span style="color: #008000;">"$public_ip"</span> <span style="color: #008000;">'whoami &amp;&amp; pwd'</span>
yes
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Create SSH config entry for easy access</span>
open ~/.ssh/config <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">we may delete an old entry first, manually</span>
cat &gt;&gt; ~/.ssh/config &lt;&lt; EOF
<span style="color: #0000ff; background-color: #EEF5FE;"># SSH over EC2 - RagFlow GPU Project</span>
<span style="color: #0000ff; background-color: #EEF5FE;">Host EC2-RagFlow-GPU</span>
<span style="color: #0000ff; background-color: #EEF5FE;">    HostName $public_ip</span>
<span style="color: #0000ff; background-color: #EEF5FE;">    User ubuntu</span>
<span style="color: #0000ff; background-color: #EEF5FE;">    IdentityFile ~/.ssh/ragflow-gpu_key</span>
<span style="color: #0000ff; background-color: #EEF5FE;">EOF</span>
<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">use a perl one-liner to grep these lines from the ssh-config file.</span>
perl -nE <span style="color: #008000;">'print if /Host EC2-RagFlow-GPU/ .. /yesEOF/'</span> ~/.ssh/config
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">bbedit ~/.ssh/config</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Test SSH with hostname</span>
ssh EC2-RagFlow-GPU <span style="color: #008000;">'whoami &amp;&amp; date'</span>

</pre>
</div>

<p>
<b>Result:</b> SSH configuration is established and remote access to the GPU EC2 instance is verified.
</p>
</div>
</div>
<div id="outline-container-org510a74b" class="outline-3">
<h3 id="org510a74b"><span class="section-number-3">4.6.</span> GPU Instance Selection and Upgrading</h3>
<div class="outline-text-3" id="text-4-6">
</div>
<div id="outline-container-org9fbcd5d" class="outline-4">
<h4 id="org9fbcd5d"><span class="section-number-4">4.6.1.</span> Recommended GPU EC2 Instance Types for RAG Workloads</h4>
<div class="outline-text-4" id="text-4-6-1">
<p>
Here is a list of recommended GPU-enabled EC2 instance types suitable for RAG workloads with RagFlow, focusing on instances with NVIDIA GPUs optimized for AI/ML tasks. All recommendations are for the <code>eu-north-1</code> region, with approximate on-demand pricing (as of late 2024)
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Instance Type</th>
<th scope="col" class="org-left">GPU</th>
<th scope="col" class="org-right">VRAM (GB)</th>
<th scope="col" class="org-right">vCPUs</th>
<th scope="col" class="org-right">RAM (GB)</th>
<th scope="col" class="org-left">Network Speed</th>
<th scope="col" class="org-left">Approx. Price/Hour (USD)</th>
<th scope="col" class="org-left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">g4dn.xlarge</td>
<td class="org-left">1x T4</td>
<td class="org-right">16</td>
<td class="org-right">4</td>
<td class="org-right">16</td>
<td class="org-left">Up to 25 Gbps</td>
<td class="org-left">$0.71</td>
<td class="org-left">Good balance for moderate RAG workloads with GPU acceleration</td>
</tr>

<tr>
<td class="org-left">g4dn.2xlarge</td>
<td class="org-left">1x T4</td>
<td class="org-right">16</td>
<td class="org-right">8</td>
<td class="org-right">32</td>
<td class="org-left">Up to 25 Gbps</td>
<td class="org-left">$1.05</td>
<td class="org-left">More CPU/RAM for larger models</td>
</tr>

<tr>
<td class="org-left">g5.xlarge</td>
<td class="org-left">1x A10G</td>
<td class="org-right">24</td>
<td class="org-right">4</td>
<td class="org-right">16</td>
<td class="org-left">Up to 10 Gbps</td>
<td class="org-left">$1.21</td>
<td class="org-left">Latest generation with more VRAM</td>
</tr>

<tr>
<td class="org-left">g6e.xlarge</td>
<td class="org-left">1x L40S</td>
<td class="org-right">48</td>
<td class="org-right">4</td>
<td class="org-right">32</td>
<td class="org-left">Up to 20 Gbps</td>
<td class="org-left">$1.22</td>
<td class="org-left">High VRAM for large models</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-orgf6612ec" class="outline-5">
<h5 id="orgf6612ec"><span class="section-number-5">4.6.1.1.</span> Recommendations</h5>
<div class="outline-text-5" id="text-4-6-1-1">
<ul class="org-ul">
<li><b>For most RAG setups</b>: Start with <code>g4dn.xlarge</code> for a balance of GPU performance, memory, and cost.</li>
<li><b>For high-performance needs</b>: Opt for <code>g5.xlarge</code> or <code>g6e.xlarge</code> if you need more VRAM for larger models.</li>
<li><b>Considerations</b>: GPU instances are more expensive but provide significant performance improvements for embeddings and inference tasks.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd8d1d90" class="outline-4">
<h4 id="orgd8d1d90"><span class="section-number-4">4.6.2.</span> Upgrading to a Different GPU Instance Type with Terraform</h4>
<div class="outline-text-4" id="text-4-6-2">
<p>
The best way to change your EC2 instance type is to update your Terraform configuration and apply the changes. 
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Changing GPU instance type with Terraform</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Navigate to the Terraform GPU directory</span>
<span style="color: #006FE0;">cd</span> <span style="color: #008000;">"$PROJECT_DIR/terraform-gpu"</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Update the instance type in terraform.tfvars (replace 'g5.xlarge' with your desired type)</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">or use an editor to change the instance type directly.</span>
sed -i <span style="color: #008000;">'s/instance_type    = "g4dn.xlarge"/instance_type    = "g5.xlarge"/g'</span> terraform.tfvars

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Review the updated configuration</span>
cat terraform.tfvars

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Generate and review the deployment plan</span>
terraform plan -out=tfplan -var-file=terraform.tfvars

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Apply the changes to upgrade the instance</span>
terraform apply tfplan

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify the instance has been upgraded</span>
aws ec2 describe-instances <span style="color: #008000;">\</span>
  --filters <span style="color: #008000;">"Name=tag:Name,Values=EC2-RagFlow-GPU"</span> <span style="color: #008000;">\</span>
  --query <span style="color: #008000;">'Reservations[*].Instances[*].[InstanceType, State.Name]'</span> <span style="color: #008000;">\</span>
  --output text
</pre>
</div>

<p>
<b>Result:</b> GPU instance type has been successfully changed to the new configuration with updated GPU capabilities.
</p>
</div>
</div>
</div>
<div id="outline-container-org30c8e7c" class="outline-3">
<h3 id="org30c8e7c"><span class="section-number-3">4.7.</span> Summary</h3>
<div class="outline-text-3" id="text-4-7">
<p>
Infrastructure automation through Terraform provisions the AWS environment with GPU support. The EC2 instance operates with proper network security configuration and NVIDIA GPU capabilities. SSH access is established through dedicated keypairs. The infrastructure exists as version-controlled code, enabling consistent reproduction across deployments.
</p>
</div>
</div>
</div>
<div id="outline-container-org7ef261d" class="outline-2">
<h2 id="org7ef261d"><span class="section-number-2">5.</span> GPU Verification</h2>
<div class="outline-text-2" id="text-5">
<p>
This verifies that the pre-installed GPU drivers, CUDA, and Docker GPU support are working correctly.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: GPU verification</span>
ssh EC2-RagFlow-GPU

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Installing NVIDIA monitoring tool nvitop</span>
sudo apt update &amp;&amp; sudo apt install -y pipx
pipx install nvitop

nvitop --version

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Check NVIDIA driver and GPU status</span>
nvidia-smi

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Check CUDA version</span>
nvcc --version

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Test GPU in Docker</span>
docker run --rm --gpus all nvidia/cuda:12.9.0-base-ubuntu24.04 nvidia-smi

<span style="color: #0000FF; font-weight: bold;">exit</span>
</pre>
</div>

<p>
<b>Result:</b> Pre-installed GPU drivers, CUDA toolkit, and Docker GPU support are verified as fully operational.
</p>
</div>
</div>
<div id="outline-container-org9abda6e" class="outline-2">
<h2 id="org9abda6e"><span class="section-number-2">6.</span> Development Environment Setup</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org6d86636" class="outline-3">
<h3 id="org6d86636"><span class="section-number-3">6.1.</span> Complete Docker Engine and Tools Installation</h3>
<div class="outline-text-3" id="text-6-1">
<p>
This establishes the complete development environment on the Ubuntu 24.04 GPU instance, including Docker Engine, container management tools, GitHub CLI, and Python development utilities.
</p>
</div>
<div id="outline-container-orgf0c4708" class="outline-4">
<h4 id="orgf0c4708"><span class="section-number-4">6.1.1.</span> Docker Engine Installation and Tools</h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
Install Docker Engine with proper repository configuration and user permissions.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Docker Engine installation on GPU instance</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Setting up containerization platform for GPU-accelerated applications</span>

ssh EC2-RagFlow-GPU

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Test Docker installation</span>
docker run hello-world

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify Docker Compose</span>
docker compose version

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Enable and Check Docker service to start on boot</span>
sudo systemctl enable docker
sudo systemctl start docker
sudo systemctl status docker  --no-pager

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Install lazydocker for terminal-based Docker management</span>
curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">'export PATH="$HOME/.local/bin:$PATH"'</span> &gt;&gt; ~/.bashrc
<span style="color: #006FE0;">source</span> ~/.bashrc

lazydocker --version

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Install htop for system monitoring</span>
sudo apt install -y htop
htop --version


<span style="color: #0000FF; font-weight: bold;">exit</span>

</pre>
</div>

<p>
<b>Result:</b> Docker insallation is varified. Docker service is configured to start automatically on EC2 instance boot.
Lazydocker is installed and available in the PATH for terminal-based Docker management. The tool htop is also installed.
</p>
</div>
</div>
<div id="outline-container-org3f6c0f8" class="outline-4">
<h4 id="org3f6c0f8"><span class="section-number-4">6.1.2.</span> Python Development Tools Installation</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
Install uv (fast Python package installer) and development libraries required for Python projects.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Python development tools installation</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Installing uv and development dependencies</span>

ssh EC2-RagFlow-GPU

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Install uv (fast Python package installer and runner)</span>
curl -LsSf https://astral.sh/uv/install.sh | sh

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify uv installation</span>
uv --version
uvx --version

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Install ICU development libraries and build tools</span>
sudo apt update
sudo apt install -y <span style="color: #008000;">\</span>
    libicu-dev <span style="color: #008000;">\</span>
    pkg-config <span style="color: #008000;">\</span>
    build-essential

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify build tools</span>
gcc --version
pkg-config --version

<span style="color: #0000FF; font-weight: bold;">exit</span>

</pre>
</div>

<p>
<b>Result:</b> Python development tools including uv, ICU libraries, and build essentials are installed and verified.
</p>
</div>
</div>
<div id="outline-container-orgd9bb34e" class="outline-4">
<h4 id="orgd9bb34e"><span class="section-number-4">6.1.3.</span> Development Environment Summary</h4>
<div class="outline-text-4" id="text-6-1-3">
<p>
Verify the complete development environment is ready for deployment.
[Editors Note: Remove the echo statements in the this code block.]
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Development environment verification</span>

ssh EC2-RagFlow-GPU

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Display installed versions</span>
docker --version
docker compose version
gh --version
uv --version
gcc --version | head -1
/usr/local/cuda/bin/nvcc --version | head -1
nvidia-smi --query-gpu=name --format=csv,noheader
uname -a
df -h /
nvidia-smi --query-gpu=memory.total --format=csv,noheader

<span style="color: #0000FF; font-weight: bold;">exit</span>

</pre>
</div>

<p>
<b>Result:</b> Complete development environment with GPU support is verified and ready for RagFlow deployment and CI/CD operations.
</p>
</div>
</div>
</div>
<div id="outline-container-orgad58f50" class="outline-3">
<h3 id="orgad58f50"><span class="section-number-3">6.2.</span> Summary</h3>
<div class="outline-text-3" id="text-6-2">
<p>
The development environment setup establishes necessary tools for containerized application deployment and CI/CD workflows on GPU-enabled infrastructure. Docker Engine provides the containerization platform, Lazydocker offers terminal management, and Python development tools support application requirements. CUDA and NVIDIA drivers enable GPU acceleration for enhanced performance.
</p>
</div>
</div>
</div>
<div id="outline-container-org852abf4" class="outline-2">
<h2 id="org852abf4"><span class="section-number-2">7.</span> Core RagFlow Deployment</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgfdaf97f" class="outline-3">
<h3 id="orgfdaf97f"><span class="section-number-3">7.1.</span> Basic Ragflow Setup</h3>
<div class="outline-text-3" id="text-7-1">
<p>
This section deploys RagFlow on the GPU-enabled EC2 instance using Docker Compose following the QuickStart guide.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: RagFlow deployment on GPU instance</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Installing and starting RagFlow RAG platform with GPU support</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">SSH into the GPU EC2 instance</span>
ssh EC2-RagFlow-GPU

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Clone the RagFlow repository</span>
<span style="color: #006FE0;">cd</span> ~; <span style="color: #006FE0;">pwd</span>
git clone https://github.com/infiniflow/ragflow.git

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Navigate to the RagFlow directory</span>
<span style="color: #006FE0;">cd</span> ~/ragflow/docker

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Update .env file to use GPU profile</span>
sed -i <span style="color: #008000;">'s/DEVICE=cpu/DEVICE=gpu/'</span> .env
cat .env | grep DEVICE

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Upate docker-compose.yml to uncomment the executor service.</span>
perl -i -pe <span style="color: #008000;">'s/^  # /  / if /^  # /'</span> docker/docker-compose.yml


<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Start RagFlow using Docker Compose</span>
docker compose up -d

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify the deployment</span>
docker ps

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Getting SERVICE_IP</span>
<span style="color: #BA36A5;">public_ip</span>=$(curl -s http://checkip.amazonaws.com)
<span style="color: #006FE0;">echo</span> $<span style="color: #BA36A5;">public_ip</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">RagFlow URL</span>
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"RagFlow is accessible at: http://$public_ip:80"</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Shutting down RagFlow (optional)</span>
docker compose stop

<span style="color: #0000FF; font-weight: bold;">exit</span>
</pre>
</div>

<p>
<b>Result:</b> RagFlow is successfully deployed and running on the GPU-enabled EC2 instance.
</p>
</div>
</div>
<div id="outline-container-org27bfe0d" class="outline-3">
<h3 id="org27bfe0d"><span class="section-number-3">7.2.</span> HTTPS Setup with Self-Signed Certificate</h3>
<div class="outline-text-3" id="text-7-2">
<p>
This section provides step-by-step instructions for setting up HTTPS access to RAGFlow using a self-signed SSL certificate on the GPU instance.
</p>

<p>
<b><b>Prerequisites</b></b>
</p>

<ul class="org-ul">
<li>Docker and Docker Compose installed on your GPU server</li>
<li>Ports 80 and 443 open on your server</li>
<li>Server's public IP address (replace &lt;SERVER<sub>IP</sub>&gt; with your actual IP throughout these instructions)</li>
<li>Basic knowledge of command-line operations</li>
</ul>
</div>
<div id="outline-container-org39644d2" class="outline-4">
<h4 id="org39644d2"><span class="section-number-4">7.2.1.</span> Step 1: Generate Self-Signed SSL Certificate**</h4>
<div class="outline-text-4" id="text-7-2-1">
<p>
Generate a self-signed certificate for your server's IP address.
</p>

<div class="org-src-container">
<pre class="src src-bash">bash
<span style="color: #006FE0;">pwd</span>
ssh EC2-RagFlow-GPU
<span style="color: #006FE0;">cd</span> ~/ragflow/docker/nginx

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Retrieve the SERVER_IP</span>
curl -s http://checkip.amazonaws.com
<span style="color: #006FE0;">export</span> <span style="color: #BA36A5;">SERVER_IP</span>=$(curl -s http://checkip.amazonaws.com)
<span style="color: #006FE0;">echo</span> $<span style="color: #BA36A5;">SERVER_IP</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Create a directory for SSL certificates</span>
mkdir -p ssl

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Generate a private key</span>
openssl genrsa -out ssl/privkey.pem 2048

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Generate a certificate signing request (CSR) for localhost or your IP</span>
openssl req -new -key ssl/privkey.pem -out ssl/cert.csr -subj <span style="color: #008000;">"/C=US/ST=State/L=City/O=Organization/CN=localhost"</span>
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">openssl req -new -key ssl/privkey.pem -out ssl/cert.csr -subj "/C=US/ST=State/L=City/O=Organization/CN=$SERVER_IP"</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Generate the self-signed certificate valid for 365 days</span>
openssl x509 -req -days 365 -in ssl/cert.csr -signkey ssl/privkey.pem -out ssl/fullchain.pem

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Set appropriate permissions</span>
chmod 600 ssl/privkey.pem
chmod 644 ssl/fullchain.pem

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify the certificate was created</span>
ls -la ssl/
cat ssl/fullchain.pem
cat ssl/privkey.pem
cat ssl/cert.csr

</pre>
</div>

<p>
After running these commands, you should see the certificate files in the ssl directory.
</p>
</div>
</div>
<div id="outline-container-org3faa15f" class="outline-4">
<h4 id="org3faa15f"><span class="section-number-4">7.2.2.</span> Step 2: Modify Nginx Configuration**</h4>
<div class="outline-text-4" id="text-7-2-2">
<p>
Update the existing ragflow.https.conf file to use your IP address.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Go to the ragflow project directory</span>
<span style="color: #006FE0;">cd</span> ~/ragflow
<span style="color: #006FE0;">pwd</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Copy the existing HTTPS config as a backup</span>
cp docker/nginx/ragflow.https.conf docker/nginx/ragflow.https.ip.conf

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Edit the configuration file to replace domain with IP and proxy path</span>
sed -i <span style="color: #008000;">"s/your-ragflow-domain.com/localhost/g"</span> docker/nginx/ragflow.https.ip.conf
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">For GPU version, use ragflow-gpu service</span>
sed -i <span style="color: #008000;">'s|http://ragflow:|http://ragflow-gpu:|'</span> docker/nginx/ragflow.https.ip.conf

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify the changes</span>
cat docker/nginx/ragflow.https.ip.conf
</pre>
</div>
</div>
</div>
<div id="outline-container-org9fbfb2e" class="outline-4">
<h4 id="org9fbfb2e"><span class="section-number-4">7.2.3.</span> Step 3: Update Docker Compose Configuration</h4>
<div class="outline-text-4" id="text-7-2-3">
<p>
Modify the docker-compose.yml file to mount the self-signed certificates.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #006FE0;">pwd</span>
<span style="color: #006FE0;">cd</span> ~/ragflow/docker

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Add certificate volumes to the ragflow service in docker-compose.yml</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Insert these lines under the existing volumes section for ragflow-cpu and ragflow-gpu services</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">For ragflow-cpu service (around line 37-44):</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Add after: - ./entrypoint.sh:/ragflow/entrypoint.sh</span>
      - ./nginx/ssl/fullchain.pem:/etc/nginx/ssl/fullchain.pem:ro
      - ./nginx/ssl/privkey.pem:/etc/nginx/ssl/privkey.pem:ro
      - ./nginx/ragflow.https.ip.conf:/etc/nginx/conf.d/ragflow.conf


<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">For ragflow-gpu service (around line 86-93):</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Add after: - ./entrypoint.sh:/ragflow/entrypoint.sh</span>
      - ./nginx/ssl/fullchain.pem:/etc/nginx/ssl/fullchain.pem:ro
      - ./nginx/ssl/privkey.pem:/etc/nginx/ssl/privkey.pem:ro
      - ./nginx/ragflow.https.ip.conf:/etc/nginx/conf.d/ragflow.conf

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify the docker-compose.yml file syntax</span>
docker compose config
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf3fa0bd" class="outline-4">
<h4 id="orgf3fa0bd"><span class="section-number-4">7.2.4.</span> Step 4: Restart RAGFlow Services</h4>
<div class="outline-text-4" id="text-7-2-4">
<p>
Stop the existing services and restart them with the new HTTPS configuration.
</p>

<div class="org-src-container">
<pre class="src src-bash">ssh EC2-RagFlow-GPU

<span style="color: #006FE0;">cd</span> ~/ragflow/docker
<span style="color: #006FE0;">pwd</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Stop all running services</span>
docker compose down
docker compose stop

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Set the profile in .env and start (CPU or GPU)</span>
docker compose  up -d

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Check that services are running</span>
docker compose ps
docker compose exec ragflow-gpu date; <span style="color: #006FE0;">pwd</span>; ls -la

</pre>
</div>
</div>
</div>
<div id="outline-container-org8612421" class="outline-4">
<h4 id="org8612421"><span class="section-number-4">7.2.5.</span> Step 5: Test HTTPS Access</h4>
<div class="outline-text-4" id="text-7-2-5">
<p>
Verify that the HTTPS setup is working correctly.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Testing HTTPS access to RagFlow</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Test HTTP to HTTPS redirect</span>
curl -I http://$<span style="color: #BA36A5;">SERVER_IP</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Test HTTPS connection (ignore certificate warnings)</span>
curl -k -I https://$<span style="color: #BA36A5;">SERVER_IP</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Check certificate details</span>
openssl s_client -connect $<span style="color: #BA36A5;">SERVER_IP</span>:443 -servername $<span style="color: #BA36A5;">SERVER_IP</span> &lt; /dev/null 2&gt;/dev/null | openssl x509 -noout -dates -subject

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify RAGFlow API is accessible over HTTPS</span>
curl -k https://$<span style="color: #BA36A5;">SERVER_IP</span>/v1/system/healthz

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Test GPU functionality in running containers</span>
docker compose exec ragflow-gpu nvidia-smi --query-gpu=name,memory.used,memory.total --format=csv

</pre>
</div>

<p>
Ragflow URL is accessible at: 
</p>
<ul class="org-ul">
<li><a href="http://13.62.214.0/">http://13.62.214.0/</a></li>
<li><a href="https://13.62.214.0/">https://13.62.214.0/</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgbfa0956" class="outline-3">
<h3 id="orgbfa0956"><span class="section-number-3">7.3.</span> Use Case: Access RagFlow via SSH-Tunnel</h3>
<div class="outline-text-3" id="text-7-3">
<p>
This creates an SSH tunnel to access RagFlow securely from a local browser.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Testing RagFlow via SSH tunnel</span>

ssh -L 9380:localhost:80 EC2-RagFlow-GPU
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Open RagFlow in your browser at http://localhost:9380</span>
<span style="color: #0000FF; font-weight: bold;">exit</span>

</pre>
</div>

<p>
When the SSH tunnel is established, RagFlow can be accessed via local browser at:
<a href="http://localhost:9380">http://localhost:9380</a>
</p>

<p>
<b>Result:</b> RagFlow is accessible via SSH tunnel and ready for document processing and RAG operations.
</p>
</div>
</div>
<div id="outline-container-org0adc4f3" class="outline-3">
<h3 id="org0adc4f3"><span class="section-number-3">7.4.</span> Summary</h3>
<div class="outline-text-3" id="text-7-4">
<p>
RagFlow deployment establishes the core RAG platform with full GPU acceleration. The application uses GPU profile with optimized Docker Compose configuration, GPU resource limits, and CUDA environment variables for maximum performance. HTTPS setup with self-signed certificates and SSH tunnel access provide secure local browser connectivity. The GPU-enabled infrastructure delivers significant performance improvements for embeddings generation, vector similarity searches, and document processing operations.
</p>
</div>
</div>
</div>
<div id="outline-container-org38c17d4" class="outline-2">
<h2 id="org38c17d4"><span class="section-number-2">8.</span> Advanced Features - Document Processing</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org75ea563" class="outline-3">
<h3 id="org75ea563"><span class="section-number-3">8.1.</span> Document Ingestion and Processing</h3>
<div class="outline-text-3" id="text-8-1">
<p>
This demonstrates uploading and processing documents for RAG functionality with GPU acceleration.
</p>
</div>
<div id="outline-container-org75ba70b" class="outline-4">
<h4 id="org75ba70b"><span class="section-number-4">8.1.1.</span> Upload Documents</h4>
<div class="outline-text-4" id="text-8-1-1">
<p>
Access RagFlow via browser and upload sample documents for processing.
</p>
</div>
</div>
<div id="outline-container-org527ec3a" class="outline-4">
<h4 id="org527ec3a"><span class="section-number-4">8.1.2.</span> Configure Knowledge Base</h4>
<div class="outline-text-4" id="text-8-1-2">
<p>
Create a knowledge base and configure document parsing settings.
</p>
</div>
</div>
<div id="outline-container-org1952bda" class="outline-4">
<h4 id="org1952bda"><span class="section-number-4">8.1.3.</span> Test RAG Queries</h4>
<div class="outline-text-4" id="text-8-1-3">
<p>
Test retrieval-augmented generation with uploaded documents, leveraging GPU acceleration for faster processing.
</p>
</div>
</div>
</div>
<div id="outline-container-org6e8685d" class="outline-3">
<h3 id="org6e8685d"><span class="section-number-3">8.2.</span> Summary</h3>
<div class="outline-text-3" id="text-8-2">
<p>
Document processing enables advanced knowledge management while preserving privacy. GPU acceleration provides enhanced performance for embeddings generation and vector similarity searches. Local processing handles sensitive documents without transmitting data to external services.
</p>
</div>
</div>
</div>
<div id="outline-container-org123bb69" class="outline-2">
<h2 id="org123bb69"><span class="section-number-2">9.</span> Infrastructure Cleanup</h2>
<div class="outline-text-2" id="text-9">
<p>
Infrastructure as Code enables rapid deployment, but equally important is the ability to cleanly tear down resources to avoid unnecessary costs. This section provides procedures for complete cleanup of all deployed GPU resources.
</p>
</div>
<div id="outline-container-org6135eba" class="outline-3">
<h3 id="org6135eba"><span class="section-number-3">9.1.</span> Stop RagFlow Services (Optional)</h3>
<div class="outline-text-3" id="text-9-1">
<p>
Before destroying infrastructure, gracefully stop all running services.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Stopping RagFlow services</span>

ssh EC2-RagFlow-GPU

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Stop RagFlow Docker containers</span>
<span style="color: #006FE0;">cd</span> ~/ragflow
docker compose --profile gpu down

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify containers are stopped</span>
docker ps -a

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Optional: Remove Docker images to free disk space</span>
docker system prune -a -f

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Exit SSH session</span>
<span style="color: #0000FF; font-weight: bold;">exit</span>
</pre>
</div>

<p>
<b>Result:</b> RagFlow services are stopped and Docker containers are removed from the GPU EC2 instance.
</p>
</div>
</div>
<div id="outline-container-org68975c9" class="outline-3">
<h3 id="org68975c9"><span class="section-number-3">9.2.</span> Terminate GPU EC2 Instance with Terraform</h3>
<div class="outline-text-3" id="text-9-2">
<p>
Use Terraform to cleanly destroy all AWS infrastructure resources including the GPU instance.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Destroying AWS GPU infrastructure</span>

<span style="color: #006FE0;">cd</span> <span style="color: #008000;">"$PROJECT_DIR/terraform-gpu"</span>
<span style="color: #006FE0;">pwd</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Review what will be destroyed</span>
terraform init
terraform plan -destroy -var-file=terraform.tfvars
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Destroy all infrastructure</span>
terraform destroy -var-file=terraform.tfvars
yes

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify destruction</span>
terraform show

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">List remaining EC2 instances (should show none with EC2-RagFlow-GPU tag)</span>
aws ec2 describe-instances <span style="color: #008000;">\</span>
  --filters <span style="color: #008000;">"Name=tag:Name,Values=EC2-RagFlow-GPU"</span> <span style="color: #008000;">\</span>
  --query <span style="color: #008000;">'Reservations[*].Instances[*].[InstanceId, State.Name]'</span> <span style="color: #008000;">\</span>
  --output text
</pre>
</div>

<p>
<b>Result:</b> All AWS GPU infrastructure resources are destroyed, including EC2 instance, security groups, and key pairs.
</p>
</div>
</div>
<div id="outline-container-orge40dac1" class="outline-3">
<h3 id="orge40dac1"><span class="section-number-3">9.3.</span> Clean Up Local SSH Configuration</h3>
<div class="outline-text-3" id="text-9-3">
<p>
Remove SSH configurations and keys associated with the destroyed GPU instance.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Removing local SSH configuration</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Cleaning up SSH keys and config entries</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Remove SSH config entry for EC2-RagFlow-GPU</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Manual edit recommended to preserve other configurations</span>
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"Removing SSH config entry for EC2-RagFlow-GPU..."</span>
perl -i.bak -ne <span style="color: #008000;">'print unless /^Host EC2-RagFlow-GPU$/..(/^Host / &amp;&amp; !/^Host EC2-RagFlow-GPU$/)'</span> ~/.ssh/config

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify removal</span>
grep -A 5 <span style="color: #008000;">"EC2-RagFlow-GPU"</span> ~/.ssh/config || <span style="color: #006FE0;">echo</span> <span style="color: #008000;">"SSH config entry removed successfully"</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Optional: Remove SSH keys (only if no longer needed)</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Uncomment the following lines if you want to delete the keys:</span>
rm -f ~/.ssh/ragflow-gpu_key
rm -f ~/.ssh/ragflow-gpu_key.pub

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">List remaining SSH keys</span>
ls -la ~/.ssh/ragflow-gpu_key*

</pre>
</div>

<p>
<b>Result:</b> SSH configuration entries are removed. SSH keys remain available for potential future deployments (remove manually if no longer needed).
</p>
</div>
</div>
<div id="outline-container-org9c8c201" class="outline-3">
<h3 id="org9c8c201"><span class="section-number-3">9.4.</span> Clean Up Terraform State Files</h3>
<div class="outline-text-3" id="text-9-4">
<p>
Clean up Terraform state and temporary files.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Cleaning up Terraform files</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Removing state and temporary files</span>
<span style="color: #006FE0;">pwd</span>
<span style="color: #006FE0;">cd</span> <span style="color: #008000;">"$PROJECT_DIR/terraform-gpu"</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">List Terraform state files</span>
ls -la terraform.tfstate*

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Optional: Back up state files before removal</span>
mkdir -p ../terraform-gpu-backups
cp terraform.tfstate* ../terraform-gpu-backups/ 2&gt;/dev/null || <span style="color: #006FE0;">echo</span> <span style="color: #008000;">"No state files to backup"</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Remove Terraform state files (only after infrastructure is destroyed)</span>
rm -f terraform.tfstate
rm -f terraform.tfstate.backup
rm -f tfplan*
rm -f terraform.tfvars

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Clean up Terraform cache</span>
rm -rf .terraform

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Verify cleanup</span>
<span style="color: #006FE0;">pwd</span>
ls -la
</pre>
</div>

<p>
<b>Result:</b> Terraform state files and temporary files are removed to complete the cleanup process.
</p>
</div>
</div>
<div id="outline-container-orgfce4a6f" class="outline-3">
<h3 id="orgfce4a6f"><span class="section-number-3">9.5.</span> Verify Complete Cleanup</h3>
<div class="outline-text-3" id="text-9-5">
<p>
Perform final verification that all resources have been removed.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Listing: Final cleanup verification</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Confirming all resources are removed</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Check for any remaining EC2 instances</span>
aws ec2 describe-instances <span style="color: #008000;">\</span>
  --filters <span style="color: #008000;">"Name=tag:project,Values=ragflow-gpu"</span> <span style="color: #008000;">\</span>
  --query <span style="color: #008000;">'Reservations[*].Instances[*].[InstanceId, State.Name, Tags[?Key==`Name`]|[0].Value]'</span> <span style="color: #008000;">\</span>
  --output table

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Check for remaining security groups</span>
aws ec2 describe-security-groups <span style="color: #008000;">\</span>
  --filters <span style="color: #008000;">"Name=group-name,Values=RagFlowGPUSecurityGroup"</span> <span style="color: #008000;">\</span>
  --query <span style="color: #008000;">'SecurityGroups[*].[GroupId, GroupName]'</span> <span style="color: #008000;">\</span>
  --output table

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Check for remaining key pairs</span>
aws ec2 describe-key-pairs <span style="color: #008000;">\</span>
  --filters <span style="color: #008000;">"Name=key-name,Values=ragflow-gpu-key"</span> <span style="color: #008000;">\</span>
  --query <span style="color: #008000;">'KeyPairs[*].[KeyName, KeyFingerprint]'</span> <span style="color: #008000;">\</span>
  --output table

<span style="color: #8D8D84;">#  </span><span style="color: #8D8D84; font-style: italic;">"Cleanup Verification Complete"</span>
</pre>
</div>

<p>
<b>Result:</b> Final verification confirms all AWS GPU resources have been properly cleaned up and removed.
</p>
</div>
</div>
<div id="outline-container-orgd064333" class="outline-3">
<h3 id="orgd064333"><span class="section-number-3">9.6.</span> Summary</h3>
<div class="outline-text-3" id="text-9-6">
<p>
Infrastructure cleanup procedures remove all deployed GPU resources. Terraform destroy commands remove AWS infrastructure, SSH configurations clean from local systems, and verification steps confirm proper resource removal. This prevents unexpected costs after project completion.
</p>

<p>
This project demonstrates that privacy-focused RAG systems are both technically feasible and practically deployable with optimized GPU acceleration using Ubuntu 24.04 and pre-configured Deep Learning AMIs. The GPU profile configuration, CUDA environment variables, and Docker resource limits ensure maximum performance for embeddings generation and vector operations. Self-hosted solutions provide alternatives to cloud-only AI services while delivering enterprise-grade GPU performance for enhanced RAG capabilities.
</p>

<p>
&#x2014;
</p>

<p>
<b>This completes the RagFlow AWS GPU deployment using live-scripting methodology. Each code block is executable with F4 in Emacs using `send-line-to-vterm`, or can be copied and pasted into any terminal for the same results.</b>
</p>
</div>
</div>
</div>
<div id="outline-container-org37103f2" class="outline-2">
<h2 id="org37103f2"><span class="section-number-2">10.</span> Appendix: Live-Cycle Operations</h2>
<div class="outline-text-2" id="text-10">
<p>
This section provides procedures for managing the GPU EC2 instance lifecycle - starting and stopping the instance when returning to work sessions after periods of inactivity.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000FF; font-weight: bold;">exit</span>

bash
<span style="color: #006FE0;">pwd</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Initialize project environment</span>
<span style="color: #BA36A5;">PROJECT_DIR</span>=<span style="color: #008000;">"~/$(whoami)/Labs/private-rag"</span>
<span style="color: #006FE0;">cd</span> <span style="color: #008000;">"$PROJECT_DIR"</span>
<span style="color: #006FE0;">export</span> <span style="color: #BA36A5;">AWS_PROFILE</span>=lab-a-north

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Get instance ID and filter out terminated instances if needed</span>
<span style="color: #BA36A5;">instance_id</span>=$(aws ec2 describe-instances --filters <span style="color: #008000;">"Name=tag:Name,Values=EC2-RagFlow-GPU"</span> <span style="color: #008000;">"Name=instance-state-name,Values=running,pending,stopping,stopped"</span> --query <span style="color: #008000;">'Reservations[*].Instances[*].[InstanceId]'</span> --output text | head -n1)
<span style="color: #006FE0;">echo</span> $<span style="color: #BA36A5;">instance_id</span>

<span style="color: #8D8D84;">### </span><span style="color: #8D8D84; font-style: italic;">STATUS: Get current instance state</span>
aws ec2 describe-instances --instance-ids <span style="color: #008000;">"$instance_id"</span> --query <span style="color: #008000;">'Reservations[*].Instances[*].[State.Name]'</span> --output text

<span style="color: #8D8D84;">### </span><span style="color: #8D8D84; font-style: italic;">START:  Start and wait for running state</span>
aws ec2 start-instances --instance-ids <span style="color: #008000;">"$instance_id"</span>
<span style="color: #0000FF; font-weight: bold;">while</span> [ <span style="color: #008000;">"$(aws ec2 describe-instances --instance-ids "$instance_id" --query "Reservations[0].Instances[0].State.Name" --output text)"</span> != <span style="color: #008000;">"running"</span> ]; <span style="color: #0000FF; font-weight: bold;">do </span><span style="color: #006FE0;">echo</span> -n <span style="color: #008000;">"."</span>; sleep 1; <span style="color: #0000FF; font-weight: bold;">done</span>; <span style="color: #006FE0;">echo</span> <span style="color: #008000;">" &#9989; running"</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Get public IP</span>
<span style="color: #BA36A5;">public_ip</span>=$(aws ec2 describe-instances --instance-ids <span style="color: #008000;">"$instance_id"</span> --query <span style="color: #008000;">'Reservations[*].Instances[*].[PublicIpAddress]'</span> --output text)
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"Instance running at: $public_ip"</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Test SSH connection with timeout of 10 seconds</span>
ssh EC2-RagFlow-GPU -v -o <span style="color: #BA36A5;">ConnectTimeout</span>=10 <span style="color: #008000;">'whoami &amp;&amp; date &amp;&amp; uptime'</span>
ssh EC2-RagFlow-GPU <span style="color: #008000;">'whoami &amp;&amp; date &amp;&amp; uptime'</span>

<span style="color: #8D8D84;">### </span><span style="color: #8D8D84; font-style: italic;">STOP: stop  the instance and wait for stopped state</span>
aws ec2 stop-instances --instance-ids <span style="color: #008000;">"$instance_id"</span>
<span style="color: #0000FF; font-weight: bold;">while</span> [ <span style="color: #008000;">"$(aws ec2 describe-instances --instance-ids "$instance_id" --query "Reservations[0].Instances[0].State.Name" --output text)"</span> != <span style="color: #008000;">"stopped"</span> ]; <span style="color: #0000FF; font-weight: bold;">do </span><span style="color: #006FE0;">echo</span> -n <span style="color: #008000;">"."</span>; sleep 1; <span style="color: #0000FF; font-weight: bold;">done</span>; <span style="color: #006FE0;">echo</span> <span style="color: #008000;">" &#9989; stopped"</span>

</pre>
</div>

<p>
<b>Result:</b> GPU EC2 instance  started and ready for use. Stop commands are provided as well.
</p>
</div>
</div>
<div id="outline-container-orgce90ced" class="outline-2">
<h2 id="orgce90ced"><span class="section-number-2">11.</span> End</h2>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2025-11-18</p>
<p class="author">Author: Andreas Wittmann</p>
<p class="date">Created: 2025-11-20 Thu 20:30</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
